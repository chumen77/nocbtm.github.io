<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>提取用于跨平台漏洞搜索的条件公式 | nocbtm's Blog</title><meta name="description" content="提取用于跨平台漏洞搜索的条件公式"><meta name="keywords" content="漏洞挖掘"><meta name="author" content="nocbtm"><meta name="copyright" content="nocbtm"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon3.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="https://nocbtm.github.io/2020/03/17/提取用于跨平台漏洞搜索的条件公式/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="提取用于跨平台漏洞搜索的条件公式"><meta name="twitter:description" content="提取用于跨平台漏洞搜索的条件公式"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta property="og:type" content="article"><meta property="og:title" content="提取用于跨平台漏洞搜索的条件公式"><meta property="og:url" content="https://nocbtm.github.io/2020/03/17/提取用于跨平台漏洞搜索的条件公式/"><meta property="og:site_name" content="nocbtm's Blog"><meta property="og:description" content="提取用于跨平台漏洞搜索的条件公式"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="Mcsema 学习记录" href="https://nocbtm.github.io/2020/03/24/Mcsema-学习记录/"><link rel="next" title="高校战“疫”网络安全分享赛 pwn 复现" href="https://nocbtm.github.io/2020/03/09/高校战“疫”网络安全分享赛-pwn-复现/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://nocbtm.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false
  
}</script></head><body><div id="header"> <div id="page-header"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">nocbtm's Blog</a></span><i class="fa fa-bars fa-fw toggle-menu pull-right close" aria-hidden="true"></i><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/learn/"><i class="fa-fw fa fa-book"></i><span> 学习资源</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 友情链接</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 大佬博客</span></a></li><li><a class="site-page" href="/link2/"><i class="fa-fw fa fa-book"></i><span> 学弟学妹们</span></a></li><li><a class="site-page" href="/link3/"><i class="fa-fw fa fa-link"></i><span> V&amp;N</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> (o≖◡≖)</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-area-chart"></i><span> 相册</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 影片</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lozad avatar_img" src="/img/header1.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">70</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">13</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">14</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/learn/"><i class="fa-fw fa fa-book"></i><span> 学习资源</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 友情链接</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 大佬博客</span></a></li><li><a class="site-page" href="/link2/"><i class="fa-fw fa fa-book"></i><span> 学弟学妹们</span></a></li><li><a class="site-page" href="/link3/"><i class="fa-fw fa fa-link"></i><span> V&amp;N</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> (o≖◡≖)</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-area-chart"></i><span> 相册</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 影片</span></a></li></ul></div><script>document.body.addEventListener('touchstart', function(){ });</script></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#概述"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">概述</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#问题描述"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">问题描述</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#解决方法"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">解决方法</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#二进制提升"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">二进制提升</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#McSema支持多种架构"><span class="toc_mobile_items-number">5.1.</span> <span class="toc_mobile_items-text">McSema支持多种架构</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#基于功能原型的翻译"><span class="toc_mobile_items-number">5.2.</span> <span class="toc_mobile_items-text">基于功能原型的翻译</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#其他问题"><span class="toc_mobile_items-number">5.3.</span> <span class="toc_mobile_items-text">其他问题</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#条件公式提取"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">条件公式提取</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#动作构建"><span class="toc_mobile_items-number">6.1.</span> <span class="toc_mobile_items-text">动作构建</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#条件提取"><span class="toc_mobile_items-number">6.2.</span> <span class="toc_mobile_items-text">条件提取</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#条件公式匹配"><span class="toc_mobile_items-number">7.</span> <span class="toc_mobile_items-text">条件公式匹配</span></a></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">2.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题描述"><span class="toc-number">3.</span> <span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方法"><span class="toc-number">4.</span> <span class="toc-text">解决方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二进制提升"><span class="toc-number">5.</span> <span class="toc-text">二进制提升</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#McSema支持多种架构"><span class="toc-number">5.1.</span> <span class="toc-text">McSema支持多种架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基于功能原型的翻译"><span class="toc-number">5.2.</span> <span class="toc-text">基于功能原型的翻译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他问题"><span class="toc-number">5.3.</span> <span class="toc-text">其他问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#条件公式提取"><span class="toc-number">6.</span> <span class="toc-text">条件公式提取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#动作构建"><span class="toc-number">6.1.</span> <span class="toc-text">动作构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#条件提取"><span class="toc-number">6.2.</span> <span class="toc-text">条件提取</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#条件公式匹配"><span class="toc-number">7.</span> <span class="toc-text">条件公式匹配</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png)"><div id="post-info"><div id="post-title"><div class="posttitle">提取用于跨平台漏洞搜索的条件公式</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-03-17<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-03-18</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/漏洞挖掘/">漏洞挖掘</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">5,360</span><span class="post-meta__separator">|</span><span>阅读时长: 16 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇文章的主要思想和方法来源于一篇论文<a href="https://www.semanticscholar.org/paper/Extracting-Conditional-Formulas-for-Cross-Platform-Feng-Wang/c75d9f1ff9177b26b7681876d7ee810d14401a49" target="_blank" rel="noopener">https://www.semanticscholar.org/paper/Extracting-Conditional-Formulas-for-Cross-Platform-Feng-Wang/c75d9f1ff9177b26b7681876d7ee810d14401a49</a><br>虽然不是最新的，但是对于研究漏洞挖掘来学习一下也不错。你可以看作本文是对这篇论文的翻译加提取。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>随着最近嵌入式系统和IoT设备中安全漏洞的增加，在跨平台环境中直接在二进制可执行文件中搜索漏洞变得越来越重要。但是，在这个领域中几乎没有探索。现有的努力易于产生大量的误报，其结果无法为人类分析家消除这些误报提供可解释的证据。在本文中，我们建议从原始二进制代码中提取条件公式作为高级语义特征，以进行代码搜索。条件公式明确捕获了错误的两个基本因素：1）错误的数据依赖性和 2）缺少条件检查或无效的条件检查。结果是，在条件公式上执行二进制代码搜索可显着提高准确性，并为人类分析人员进一步检查搜索结果提供有意义的证据。我们已经实现了XMATCH原型，并使用包括OpenSSL和BusyBox在内的知名软件对其进行了评估。实验结果表明，XMATCH在准确性方面优于现有的错误搜索技术。此外，通过评估5个最近的漏洞，XMATCH为人类分析人员提供了明确的证据，以确定匹配的候选对象是否确实易受攻击或已被修补。实验结果表明，XMATCH在准确性方面优于现有的错误搜索技术。此外，通过评估5个最近的漏洞，XMATCH为人类分析人员提供了明确的证据，以确定匹配的候选对象是否确实易受攻击或已被修补。实验结果表明，XMATCH在准确性方面优于现有的错误搜索技术。此外，通过评估5个最近的漏洞，XMATCH为人类分析人员提供了明确的证据，以确定匹配的候选对象是否确实易受攻击或已被修补。</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>我们以真实漏洞CVE- 2013 -6449为例。图1说明了x86和MIPS的ssl_get_algorithm2的两个二进制函数。x86版本是从OpenSSL库(版本1.0. la)编译而成的，而MIPS版本是从基于Linux的路由器固件DD-WRT (版本r21676) 中直接提取的。这两个代码段均包含漏洞CVE-2013- 6449，该漏洞使远程攻击者可以通过来自TLS 1. 2客户端的特制流量发起拒绝服务攻击(守护程序崩溃)。在此示例中，向我们提供了x86的易受攻击的函数ssl_get_algorithm2,我们旨在从路由器固件中搜索剥离后的二进制文件中的同一易受攻击的函数，并根据匹配结果确定每个匹配的候选对象是否确实易受攻击:误报或已应用于脆弱功能的补丁。<br><img alt="图1" data-src="https://d3i71xaburhd42.cloudfront.net/c75d9f1ff9177b26b7681876d7ee810d14401a49/2-Figure1-1.png" class="lozad"><br>图1：在不同架构（x86与MIPS）下易受攻击的函数ssl_get_algorithm2（CVE-2013-6449）的控制流程图比较。</p>
<p>从这个例子中，我们观察到跨平台二进制代码搜索的一些挑战:</p>
<ul>
<li><p>句法表示形式非常不同。x86和MIPS具 有完全不同的指令集。他们采用不同的策略来传递函数参数: x86通 常是放大堆栈以传递参数，而MIPS将参数保存在特殊寄存器中。此外，它们使用不同的机制进行条件分支: x86 .依赖于隐式EFLAGS寄存器，而MIPS则不依赖。 如图1所示，指令语法和指令计数有很大不同。因此，任何基于表面特征(例如，操作码类型和数量）的代码搜索技术都可能不会产生非常好的准确性。</p>
</li>
<li><p>控制流图不一致。在两个平台上编译的相同函数的控制流图非常不同的结构。在图1中，虽然x86二进制文件包含4个基本块，但NIPS功能却包含5个基本块。此类CFG更改可能会成为先前代码搜索工作的重要障碍,这依赖于基本决级别的特征提取和语义比较。相反,为了解决此问题，我们建议使用基于行为的高级语义来搜索安全性错误，包括数据依赖性和分支谓词。这些因素揭示了基本的程序行为，而不是易失的代码形成，因此对CFG级别的结构变化不敏感。</p>
</li>
<li><p>易受攻击的代码逻辑通常分散在多个基本块中。图1中所示的漏洞是由于对ssl_get_algorithm2参数的版本检查不正确引起的， 但是此代码逻辑跨越多个基本块，并与其他代码逻辑合。因此，要精确定位并确认此漏河，就像先前的工作一样，不足以匹配各个基本块。相反，有必要将涉及多个基本块的滑河作为一个整体来考虑并重新构建。</p>
</li>
</ul>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>我们在图2中概述了我们的方法。它包括以下三个步骤:二进制提升，条件公式提取和条件公式匹配。二进制提升。我们首先利用二进制提升将不同的本地机器代码转换为相同的更高级别的中间表示(IR)。提升后的二进制文件保留与原始二进制程序一致的语义。 我们随后的操作将直接在提升后的二进制文件上进行。条件公式提取。我们对提升后的二进制应用二进制分析技术来构造条件公式。我们通过指针仔细处理数据依赖性。此外，并非所有提升二元函数中的变量都有意义。我们进行动作点选择以过滤不相关的变量。条件公式匹配。我们通过函数的统一条件公式对其进行匹配。我们将匹配问题建模为线性分配问题，并利用编程技术来找到最住解决方案。然后，除了简单的相似性得分外，匹配结果还和CF的一对一映射。因此，分析人员可以检查深度映射结果，以了解和验证任何发现的错误。</p>
<p><img alt="图2" data-src="https://d3i71xaburhd42.cloudfront.net/c75d9f1ff9177b26b7681876d7ee810d14401a49/4-Figure4-1.png" class="lozad"></p>
<p>图2：输入是实现x86和MIPS的ssl_get_algorithm2函数的二进制文件，其中包含漏河CVE 2013-6449。首先,将两个二进制文件提升为中间表示(IR)。第二，从提升的二元函数中提取条件公式。最后，条件匹配适用于相似度得分，并输出一对一的映射结果。</p>
<h2 id="二进制提升"><a href="#二进制提升" class="headerlink" title="二进制提升"></a>二进制提升</h2><p>二进制提升将不同体系结构的二进制代码转换为通用代码表示形式，以方便后续分析。我们需要为一个函数提取条件公式，这种转换必须保留整个函数的语义。为此，我们首先恢复功能的控制流程图，然后按照控制流程图对指令进行二进制转换。关于实现，我们的二进制提升基于McSema， 一种代码转换框架，可将x86指令转换为LLVW IR (中间表示)。为了解决跨平台错误搜索的问题，我们在两个方面扩展了Mc-Sema: 1) 多体系结构支持; 2)基于功能原型的翻译。</p>
<h3 id="McSema支持多种架构"><a href="#McSema支持多种架构" class="headerlink" title="McSema支持多种架构"></a>McSema支持多种架构</h3><p>McSema提供了一个通用框架，使我们能够轻松支持其他指令集。在当前的XMATCH实现中，我们扩展了对MIPS的支持，因为它是流行的CPU架构，嵌入式系统和IoT设备的架构。</p>
<p>McSema需要两个步骤来转换二进制函数: 1) 控制流程图恢复，以及2)生成位代码。控制流程图恢复将分解一个二进制函数，检索其基本块以及这些基本块之间的控制流依赖性。生成位码将遍历控制流程图，进行一对一 的指令转换并生成LLV位码文件。我们利用IDA Pro来检索MIPS二进制函数的控制流程图。McSema通过对每个指令的执行语义进行建模，将每个指令转换为x86二进制文件。我们遵循类似的指令翻译过程。MIPS属于RISC指令集，因此在McSema中添加这种支持的工作量比添加对x86等CISC指令集的支持要简单得多。在我们的案例中，我们在McSema中添加的0C少于1K,这是一次性的工作。</p>
<h3 id="基于功能原型的翻译"><a href="#基于功能原型的翻译" class="headerlink" title="基于功能原型的翻译"></a>基于功能原型的翻译</h3><p>对于函数调用翻译，McSema引入了全局“con-test registers”数据类型，并将其用作所有提升函数的唯一参数。“con-test registers”包括以下所有寄存器相应的CPU架构。在解除功能的开始，MeSena首先分配几个局部变量，然后将全局“con-test registers”参数中的所有寄存器溢出到这些变量中。然后，基于变量执行以下操作。当函数返回时，“con-test registers”将包含最新的变量值。在每个函数调用站点，这意味着将调用提升的函数，首先包装“con-test registers”，然后将其作为唯一参数传递给被调用方。结果，McSema可以保留功能之间的控制和数据流依赖性，而无需执行功能原型恢复。但是，这种翻译策略将削弱XMATCH的功效。首先，在没有函数原型恢复的情况下，生成的条件公式无法在函数的实参上表示执行语义，因为某些缺陷代码逻辑可能与函数调用(例如nemcpy).上 的实参有关。其次，统一函数原型将降低XMATCH的准确性，因为我们不能依靠参数的数量来进一步优化搜索结果。为了解决.上面讨论的这些问题，我们要求McSena根据函数原型翻译函数调用指令。更具体地说，可通过三个步骤来实现此目标:</p>
<ul>
<li>函数原型恢复</li>
<li>函数调用转换</li>
<li>参数传递模型</li>
</ul>
<p>我们首先恢复二进制函数的函数原型，然后基于恢复的函数原型在McSema中修改函数调用转换机制。我们还添加了其他IR指令,以对传递给相应呼叫站点的参数进行建模。</p>
<p>函数数原型包括函数名称，其参数和返回值。我们利用IDApro来获取恢复的功能原型。与许多其他功能原型算法和平台相比，IDA pro可能具有局限性。但是，它是用户友好的，并且支持多个平台。此外，我们的实验表明，这足以满足我们的实验目的。将来，我们将采用更强大的方法进行进一步的改进。 我们在函数调用上分配所有函数-翻译期间返回值的站点。我们将在生成条件公式中进行筛选过程，以减少虚假回报值对生成的条件公式的影响。</p>
<p>当McSema翻泽函数调用指令时，它将预先定义要翻译的参数数量。在其原始设计中，它始终假定参数数目为1。在我们的sce-nario中，参数数目由恢复的函数原型定义。我们创建的参数变量具有在函数原型中定义的相同数量的参数。我们还为每个提升的函数创建了返回变量。</p>
<p>由于在MeSema中已更改了函数调用指令的转换，因此我们还需要添加相应的参数传递指令，以保留调用者函数与其被调用者之间的数据流依赖性。对参数传递进行建模取决于原始二进制函数的调用约定类型。我们通过调用约定的类型对它们进行建模，并通过匹配我们的建模模式来检查调用约定的类型。对于调用约定类型，我们在函数调用指令之前添加传递IR指令的相应参数。</p>
<p>图3显示了如何在x86和MIPS架构上转换的具体示例。在此示例中，根据IDA中的分析，我们知道功能栏具有两个参数，因此在呼叫站点，呼叫栏和ja1栏将被翻译为多个IR指令，如图所示。数字。调用指令之前的指令描述了如何将参数传递给相应的函数。</p>
<p><img alt="图3" data-src="https://d3i71xaburhd42.cloudfront.net/c75d9f1ff9177b26b7681876d7ee810d14401a49/5-Figure5-1.png" class="lozad"></p>
<h3 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h3><p>McSema不支持各种x86指令的翻译。例如，它仅支持-小部分浮点指令。但是，McSema有据可查， 并且为所需的其他说明添加支持并不困难。在这种情况下，对我们而言，为条件公式提取所必需的条件分支提供支持非常重要，因此我们]添加了McSema不支持的这种浮点指令的支持。我们相信支持所有说明是工程工作，并将其留作未来工作。</p>
<h2 id="条件公式提取"><a href="#条件公式提取" class="headerlink" title="条件公式提取"></a>条件公式提取</h2><p>我们直接对提升函数进行静态分析，以提取其条件公式。更具体地说，我们进行过程内数据流分析以构造动作公式，并执行路径切片以检索相应条件。所有静态分析都是在LLVM框架之上进行的。</p>
<h3 id="动作构建"><a href="#动作构建" class="headerlink" title="动作构建"></a>动作构建</h3><p>动作是特定R变量上的数据流方程，用作函数输山。为了构造一个动作，我们首先发现所有具有外部影响的函数输出(我们称它们为“动作点”)。然后，从每个动作点开始，我们计算ust def链以评估从函数输出到输入的可达性。最終，我们将每条迹线上的所有IR语句折叠起来，以产生-一个数据流万程，作为对相应动作点的动作。动作点选择。直观地。我们可以为函数中托管的任何IR变量计算数据流方程。但是，提升函数仍然保留许多体系结构特定的变量，例如图5n)中的ESP val和图5b)中的a0 valo这将使生成的条件公式在整个体系结构中截然不同。因此,我们仅关注稳定的输出状态，这些状态表示一致的程序行为。为此，我们旨在从三种类型的函数输出中计算反向数据流:1)返回值: 2) 内存变量; 3) 函数调用。</p>
<p>1)返回值。即使我们假设提升的二进制文件中的所有函数在第3.2节中讨论的二进制提升过程中都具有返回值，我们也会进行保守分析以识别持有这回值的变量。首先，我们寻找具有特定寄存器名称的IR变量。这是由于这样的事实，即某种体系结构使用特定的寄存器来保存返回值和IR变量(尽管从二进制中取出)仍保留了原始寄存器名称。第二，在这些候选变量中，我们进一步搜索那些从未在同一函数中重新定义的变量。然后，我们考虑这些变量包含返回值。</p>
<p>2)内存变量。函数也可以写入内存。这将转换为提升双字节的存储器写操作。因此，我们通过首先搜索LLVM IR中的存储器写指令storeinst来获得存储器变量。接下来，我们执行值集分析。以确定指针指向的内存区域。一旦未在函数中更新存储区域。则其指针现在指向实际输出。因此可以将其视为动作点。</p>
<p>3)函数调用。一个函数可以调用另一个函数。如果调用方函数性用或检查被调用方函数的这回值，则被调用方函数最终将包含在使用该返回值的变量的数据流表达式中。如果在调用者函数中从未使用过call函数的返回值，则将其视为操作点。</p>
<h3 id="条件提取"><a href="#条件提取" class="headerlink" title="条件提取"></a>条件提取</h3><p>我们进一步利用路径切片算法(JHALA,MAJUNDAR)为每个动作生成条件。在我们的方案中，路径切片用于提取在其中保存操作的特定路径的条件取消二进制功能。给定操作和计算出的数据流，我们将切片标准设置为在操作中包括所有变量。根据切片标准，路径切片算法将向后追潮，以找到包含切片标准中所有变量的路径切片。我们从路径切片中提取所有比较变量并为这些变量生成请词表达式。每个pred-icate表达式包括条件表达式及其布尔值，这些值将导致动作被执行。在LLWI- IR中，如果它是条件跳转，则比较变量是分支指令的第一个操作数。 我们为条件变量生成数据流方程，以获取此基本块上的条件表达式我们可以通过检查成功获取布尔值-路径上的块。如果其地址是分支变量的第二个操作数。则布尔值为true。否则为假。如果布尔值是false,我们将否定条件表达式。我们将在路径切片上发现的清词表达式作为动作v的条件进行结合。</p>
<p>运行示例。图7展示了eax动作的条件生成过程。图7(a)列出了针对eax的两个操作: a0+2和a0+1。这表明eax可以根据要采用的数据流路径保留两个不同的值。图7 (b)显示.了两个动作的路径标准，每个动作都涉及3个IR变量。在图7(b)中也显示了相应的操作路径切片。这些切片不仅包括数据流。还包括所有条件。然后，我们可以演历这些路径切片，提取所有分支变量，并对其数据流方程进行组合。结果成为执行此操作的条件。动作a0 + 1和a0 + 2的条件生成输出在图7 (e)中列出。</p>
<p><img alt="" data-src="https://d3i71xaburhd42.cloudfront.net/c75d9f1ff9177b26b7681876d7ee810d14401a49/6-Figure7-1.png" class="lozad"></p>
<h2 id="条件公式匹配"><a href="#条件公式匹配" class="headerlink" title="条件公式匹配"></a>条件公式匹配</h2><p>我们通过两个还数的条件公式进行匹配。它包括两个步骤。首先，我们计算两个的匹配成本CFs。其次，我们寻求CF之间的最佳匹配s由se-选择两组CF之间的最小匹配成本s和然后输出两个函数的相似度得分。直观上，可以利用字符串编辑距离来计算两个CF之间的匹配成本。但是，由于顺序不同，两个语义上等效的CF可能看起来是不同的。例如，( (a&gt; 0) &amp; (b&gt; 0) ) /ret0x20800将被视为与((b&gt;0)&amp;(a&gt;0))/ret=0x20800不相等，即使它们具有相同的行为级别的义。因为具有通信属性。为了避免重新排序问题，我们改为过其AST结构匹配两个CF。由于AST是树状结构,因此我们用图形编辑距离来计算在两个CF之间转换的成本。</p>
<p>我们利用算法[38]计算图形编辑距离ged (cfi, ecfj) 。在我们的情况下，并非所有节点都可以互换。例如，条件相关节点不能被动作相关节点代替。因此，在预先计算的映射成本矩阵算法中，我们为动作节点和条件芒点之间的映射成本分配了无限数。然后，使用两个CF的距离来计算两个函数的匹配成本。假设我们给了两个函数f1和f2,其中f1包含CF集[cf1。ef2, 。.. efn}和f2拥有集合1c 1,。… cfm).令mij为CF对的匹配因子:如果efi匹配ef，则u1j = 1;否则，mij=0。 因此，所有匹配因子形成一个匹配矩阵Mn × m，这说明了这两个函数如何相互对应。根据图形编辑距离。我们定义函数distance作为f1之间所有匹配的CF对的最小距离和f2。如我们所见，找到函数距离等于，找到最小的M(i，j)1小distlet. 。在换句话说。我们需要找到最佳匹配(最小匹配距离)之间的距离。请注意，由于贪婪方法只能产生次优的解决方案。因此无法单独使用每个函数中的CF的贪婪方法。寻找最优解，我们制定以下目标函数:<br><img alt="" data-src="https://i.loli.net/2020/03/18/iDrbAKG8Z2nQPTN.png" class="lozad"><br>(1) 是计算匹配的CF对之间的距离，并最小化该值。表示功能中每个CF的约束只能匹配一次。基于等式(1)，我们可以正式介绍函数距离。定义fl和f2的函数距离是fl和f2之间所有匹配的CF对的最小距离。令M代表方程的最佳解。</p>
<p>[38] Y. David, N. Partush, and E. Yahav, ‘‘Statistical similarity of binaries,’’ACM SIGPLAN Notices, vol. 51, no. 6, pp. 266–280, 2016.</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">nocbtm</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nocbtm.github.io/2020/03/17/提取用于跨平台漏洞搜索的条件公式/">https://nocbtm.github.io/2020/03/17/提取用于跨平台漏洞搜索的条件公式/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://nocbtm.github.io">nocbtm's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/漏洞挖掘/">漏洞挖掘    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechatpay.png"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.png"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/24/Mcsema-学习记录/"><img class="prev_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Mcsema 学习记录</span></div></a></div><div class="next-post pull-right"><a href="/2020/03/09/高校战“疫”网络安全分享赛-pwn-复现/"><img class="next_cover lozad" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>高校战“疫”网络安全分享赛 pwn 复现</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/11/12/AFL漏洞挖掘/" title="AFL漏洞挖掘"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">AFL漏洞挖掘</div></a></div><div class="relatedPosts_item"><a href="/2020/03/24/Mcsema-学习记录/" title="Mcsema 学习记录"><img class="relatedPosts_cover lozad"data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><div class="relatedPosts_title">Mcsema 学习记录</div></a></div></div><div class="clear_both"></div></div></div></div><footer><div id="footer"><div class="copyright">&copy;2018 - 2020 By nocbtm</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div><div class="icp"><a><img class="icp-icon" src="/img/icp.png"><span></span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="nightshift fa fa-moon-o" id="nightshift" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script src="/js/baidupush.js"> </script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful = true; // make power mode colorful
POWERMODE.shake = true; // turn off shake
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();
</script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":"wanko","mobileShow":false,"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>